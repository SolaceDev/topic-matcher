export class App {

  selected = null;

  newTopic = "F/G/F/B";
  response = [{"name":"App-00","subscribingTopics":["G/E/D/*/H/>","H/B/>","A/A/*/*/G/*","*/H/A/*/>","C/G/G/B/H/*","*/A/*/A/*/>","G/*/C","*/*/>","*/*/C/*/*/*","*/H/*/>","*/*/F","C/C/E/*/*","*/C/F/>"],"publishingTopics":["C/J/H/G","G/I/E/F/H","J/G/J","G/B/C/E","E/I/B/B/C","F/H/D","B/A/C/C/A/J","D/C/G","F/D/A/D/I/D","H/B/E/H","B/D/E","A/H/J"],"topicsMatchingSubscriptions":["H/B/E/H"]},{"name":"App-01","subscribingTopics":["J/I/>","I/*/>","E/D/H/*/E/>","*/A/*/>","B/C/>","*/H/A/*/C","*/A/*/A/*/>","H/H/*/>","*/*/*/*/*","E/*/*/G/G/>","H/F/*","*/*/>","*/*/*/D/E/>","D/*/A/*","*/*/F","C/C/E/*/*","*/H/*"],"publishingTopics":["D/B/B","A/C/I","E/C/H/H/J","I/E/I/F/F/B","C/J/H/G","G/I/E/F/H","H/A/I/J/B","F/H/D","E/C/F/I","B/A/C/C/A/J","D/C/G","G/G/F/B/I","B/H/B/C","F/G/F/B","H/B/E/H","B/D/E"],"topicsMatchingSubscriptions":["I/E/I/F/F/B"]},{"name":"App-02","subscribingTopics":["J/I/>","C/G/G/B/H/*","B/*/>","G/*/C","H/F/*","*/*/C/*/*/*","*/H/*/>","D/*/A/*","*/*/F","*/H/*","*/C/F/>"],"publishingTopics":["D/H/B/G","G/I/J/B","F/H/J/F/J/A","E/C/H/H/J","H/I/C","G/G/E/G/G","C/G/B/F/C/G","C/J/H/G","J/G/J","H/A/I/J/B","E/I/B/B/C","F/H/D","E/C/F/I","F/I/E/E/A/A","B/A/C/C/A/J","D/C/G","F/D/A/D/I/D","B/H/B/C","D/H/C/I/B","F/G/B/D","A/H/J"],"topicsMatchingSubscriptions":["B/D/E","B/A/C/C/A/J","B/H/B/C"]},{"name":"App-03","subscribingTopics":["B/C/>","*/E/*","*/H/A/*/C","*/G/>","A/*/E/D/>","B/*/>","H/H/*/>","*/C/A/>","H/F/*","*/*/>","*/*/*/D/E/>","E/F/>","E/G/G/F/>","A/F/H/G/*","*/H/*","*/C/F/>"],"publishingTopics":["D/B/B","G/G/I","A/C/I","I/E/I/F/F/B","C/G/B/F/C/G","C/J/H/G","G/I/E/F/H","F/H/D","E/C/F/I","F/I/E/E/A/A","D/C/G","G/C/A","F/I/E/C/A/I","G/G/F/B/I","H/B/E/H","D/H/C/I/B"],"topicsMatchingSubscriptions":["B/D/E","B/A/C/C/A/J","B/H/B/C"]},{"name":"App-04","subscribingTopics":["G/E/D/*/H/>","J/I/>","H/B/>","*/H/A/*/>","*/H/A/*/C","J/*/*/>","*/G/>","G/B/D/>","B/*/>","H/H/*/>","E/F/>","H/*/*/>","*/H/*/>","D/*/A/*","C/C/E/*/*"],"publishingTopics":["D/H/B/G","E/J/C/D/F/B","A/C/I","H/I/C","C/G/B/F/C/G","G/I/J/E/H","G/B/C/E","H/A/I/J/B","F/H/D","F/I/E/E/A/A","G/G/F/B/I","B/D/E","D/H/C/I/B","A/H/J"],"topicsMatchingSubscriptions":["J/G/J","B/D/E","H/B/E/H","H/A/A/J/F","H/A/I/J/B","J/D/H/F","H/I/C","B/A/C/C/A/J","B/H/B/C"]},{"name":"App-05","subscribingTopics":["E/D/H/*/E/>","B/C/>","H/H/>","*/A/*/A/*/>","J/*/*/>","*/G/>","H/H/*/>","H/F/*","A/F/H/G/*"],"publishingTopics":["I/E/I/F/F/B","H/I/C","G/G/E/G/G","J/G/J","E/C/F/I","B/A/C/C/A/J","D/C/G","F/D/A/D/I/D","G/G/F/B/I","F/G/F/B","D/G/J","J/D/H/F","B/D/E"],"topicsMatchingSubscriptions":["J/G/J","J/D/H/F"]},{"name":"App-06","subscribingTopics":["G/E/D/*/H/>","J/I/>","*/A/*/>","H/H/>","J/*/*/>","A/*/E/D/>","*/*/*/*/*","*/C/A/>","A/F/H/G/*","*/H/*/>","*/*/F","*/H/*"],"publishingTopics":["D/B/B","G/I/J/B","F/H/J/F/J/A","G/G/I","G/I/J/E/H","G/I/E/F/H","J/G/J","H/A/A/J/F","F/I/E/E/A/A","B/A/C/C/A/J","G/G/F/B/I","F/G/B/D"],"topicsMatchingSubscriptions":["J/G/J","J/D/H/F"]},{"name":"App-07","subscribingTopics":["I/*/>","B/C/>","H/H/>","*/H/A/*/C","*/A/*/A/*/>","E/F/>","*/*/C/*/*/*","E/G/G/F/>","*/*/F","*/H/*"],"publishingTopics":["D/B/B","G/G/I","C/G/B/F/C/G","C/J/H/G","D/C/G","G/C/A","B/H/B/C","J/D/H/F","F/G/B/D"],"topicsMatchingSubscriptions":["I/E/I/F/F/B"]},{"name":"App-08","subscribingTopics":["A/A/*/*/G/*","*/H/A/*/>","*/A/*/>","*/H/A/*/C","*/A/*/A/*/>","J/*/*/>","G/B/D/>","H/H/*/>","*/*/*/*/*","*/*/>","E/F/>","C/C/E/*/*"],"publishingTopics":["D/H/B/G","D/B/B","G/I/J/B","F/H/J/F/J/A","A/C/I","I/E/I/F/F/B","C/G/B/F/C/G","G/I/E/F/H","H/A/I/J/B","E/I/B/B/C","E/C/F/I","F/I/E/E/A/A","F/G/F/B","D/G/J","B/D/E","A/H/J"],"topicsMatchingSubscriptions":["J/G/J","J/D/H/F"]},{"name":"App-09","subscribingTopics":["G/E/D/*/H/>","J/I/>","A/A/*/*/G/*","I/*/>","*/A/*/>","F/*/B/B/G/>","*/E/*","*/A/*/A/*/>","*/G/>","G/B/D/>","H/H/*/>","*/C/A/>","E/*/*/G/G/>","H/F/*","E/G/G/F/>","A/F/H/G/*","*/H/*/>"],"publishingTopics":["D/B/B","G/I/J/B","G/G/I","H/I/C","G/G/E/G/G","C/G/B/F/C/G","G/I/E/F/H","G/B/C/E","E/C/F/I","F/D/A/D/I/D","G/G/F/B/I","F/G/F/B","F/H/D/J/C/G","D/G/J"],"topicsMatchingSubscriptions":["I/E/I/F/F/B"]},{"name":"App-10","subscribingTopics":["J/I/>","H/H/>","F/*/B/B/G/>","*/H/A/*/C","A/*/E/D/>","H/H/*/>","E/*/*/G/G/>","*/*/>","E/F/>","A/F/H/G/*","*/*/F","*/H/*"],"publishingTopics":["D/B/B","F/H/J/F/J/A","G/G/I","H/I/C","G/I/J/E/H","G/I/E/F/H","J/G/J","H/A/A/J/F","E/C/F/I","F/I/E/E/A/A","G/C/A","B/H/B/C","D/G/J","J/D/H/F","D/H/C/I/B"],"topicsMatchingSubscriptions":[]},{"name":"App-11","subscribingTopics":["G/E/D/*/H/>","H/B/>","C/G/G/B/H/*","*/A/*/>","J/*/*/>","*/*/*/D/E/>","A/F/H/G/*","*/H/*/>","*/*/F"],"publishingTopics":["D/H/B/G","E/J/C/D/F/B","A/C/I","E/C/H/H/J","C/J/H/G","G/I/E/F/H","E/C/F/I","F/D/A/D/I/D","G/G/F/B/I","F/H/D/J/C/G"],"topicsMatchingSubscriptions":["J/G/J","H/B/E/H","J/D/H/F"]},{"name":"App-12","subscribingTopics":["G/E/D/*/H/>","H/B/>","*/A/*/>","H/H/>","*/E/*","*/G/>","H/H/*/>","*/*/*/*/*","*/C/A/>","E/B/*/*/J/>","E/F/>","*/*/C/*/*/*","E/G/G/F/>","D/*/A/*","*/*/F","*/H/*","*/C/F/>"],"publishingTopics":["D/H/B/G","D/B/B","E/J/C/D/F/B","G/I/J/B","H/I/C","G/G/E/G/G","G/I/E/F/H","D/C/G","G/G/F/B/I","J/D/H/F"],"topicsMatchingSubscriptions":["H/B/E/H"]},{"name":"App-13","subscribingTopics":["*/A/*/>","F/*/B/B/G/>","*/G/>","*/*/*/*/*","*/C/A/>","E/*/*/G/G/>","H/F/*","*/*/*/D/E/>","H/*/*/>"],"publishingTopics":["D/B/B","E/J/C/D/F/B","F/H/J/F/J/A","G/G/I","H/I/C","F/I/H/E","G/I/E/F/H","H/A/I/J/B","D/C/G","F/I/E/C/A/I","G/G/F/B/I","J/D/H/F","D/H/C/I/B"],"topicsMatchingSubscriptions":["H/B/E/H","H/A/A/J/F","H/A/I/J/B","H/I/C"]},{"name":"App-14","subscribingTopics":["A/A/*/*/G/*","*/H/A/*/>","F/*/B/B/G/>","*/H/A/*/C","J/*/*/>","A/*/E/D/>","*/C/A/>","E/*/*/G/G/>","E/B/*/*/J/>","H/F/*","H/*/*/>","D/*/A/*","*/H/*","*/C/F/>"],"publishingTopics":["D/H/B/G","F/H/J/F/J/A","A/C/I","G/G/E/G/G","G/I/E/F/H","J/G/J","G/B/C/E","H/A/I/J/B","F/H/D","F/D/A/D/I/D","F/I/E/C/A/I","B/H/B/C","F/G/F/B","F/H/D/J/C/G","H/B/E/H","D/H/C/I/B"],"topicsMatchingSubscriptions":["J/G/J","H/B/E/H","H/A/A/J/F","H/A/I/J/B","J/D/H/F","H/I/C"]},{"name":"App-15","subscribingTopics":["*/H/A/*/>","E/D/H/*/E/>","*/H/A/*/C","*/G/>","G/B/D/>","B/*/>","*/C/A/>","E/*/*/G/G/>","*/*/>","E/F/>","*/H/*/>"],"publishingTopics":["D/B/B","G/I/J/B","G/G/I","H/I/C","G/G/E/G/G","F/I/H/E","G/I/E/F/H","E/I/B/B/C","F/H/D","D/G/J","H/B/E/H","D/H/C/I/B"],"topicsMatchingSubscriptions":["B/D/E","B/A/C/C/A/J","B/H/B/C"]},{"name":"App-16","subscribingTopics":["G/E/D/*/H/>","J/I/>","H/B/>","A/A/*/*/G/*","*/H/A/*/>","E/D/H/*/E/>","B/C/>","J/*/*/>","*/G/>","G/B/D/>","H/H/*/>","*/*/>","E/F/>","*/*/C/*/*/*","C/C/E/*/*","*/H/*"],"publishingTopics":["G/I/J/B","A/C/I","H/I/C","C/J/H/G","G/B/C/E","E/C/F/I","B/A/C/C/A/J","B/H/B/C","D/G/J","B/D/E","A/H/J"],"topicsMatchingSubscriptions":["J/G/J","H/B/E/H","J/D/H/F"]},{"name":"App-17","subscribingTopics":["B/C/>","J/*/*/>","*/G/>","B/*/>","G/*/C","*/*/*/*/*","*/C/A/>","E/B/*/*/J/>","H/F/*","*/*/*/D/E/>","A/F/H/G/*","*/H/*"],"publishingTopics":["D/B/B","F/H/J/F/J/A","A/C/I","C/G/B/F/C/G","G/I/J/E/H","J/G/J","G/B/C/E","H/A/I/J/B","E/C/F/I","F/I/E/E/A/A","B/A/C/C/A/J","G/C/A","B/H/B/C","D/G/J","H/B/E/H","B/D/E","D/H/C/I/B","A/H/J"],"topicsMatchingSubscriptions":["J/G/J","B/D/E","J/D/H/F","B/A/C/C/A/J","B/H/B/C"]},{"name":"App-18","subscribingTopics":["H/B/>","A/A/*/*/G/*","*/H/A/*/>","C/G/G/B/H/*","H/H/>","*/G/>","G/*/C","*/*/*/*/*","*/C/A/>","E/*/*/G/G/>","E/B/*/*/J/>","H/F/*","*/*/>","*/*/*/D/E/>","H/*/*/>","D/*/A/*","*/H/*","*/C/F/>"],"publishingTopics":["A/C/I","E/C/H/H/J","H/I/C","C/J/H/G","G/I/E/F/H","B/A/C/C/A/J","D/C/G","F/D/A/D/I/D","G/C/A","G/G/F/B/I","B/D/E","D/H/C/I/B","A/H/J"],"topicsMatchingSubscriptions":["H/B/E/H","H/A/A/J/F","H/A/I/J/B","H/I/C"]},{"name":"App-19","subscribingTopics":["A/A/*/*/G/*","*/E/*","*/A/*/A/*/>","B/*/>","E/B/*/*/J/>","*/*/>","*/*/C/*/*/*","C/C/E/*/*","*/H/*"],"publishingTopics":["D/H/B/G","C/G/B/F/C/G","G/I/J/E/H","C/J/H/G","G/I/E/F/H","G/B/C/E","B/A/C/C/A/J","D/C/G","G/C/A","F/I/E/C/A/I","B/H/B/C","F/H/D/J/C/G","D/H/C/I/B","A/H/J"],"topicsMatchingSubscriptions":["B/D/E","B/A/C/C/A/J","B/H/B/C"]}];

	activate() {
		// d3.request("http://34.203.75.134:8080/applications")
		// .header("Content-Type", "application/json")
		// .get((response) => {
		//   console.log(response);
		// });
		const allTopics = new Set();
		this.data = {nodes:[], links:[]};
		this.response.forEach(app => {
			this.data.nodes.push({id: app.name, group: 1});
			app.publishingTopics.forEach(topic => {
					allTopics.add(topic);
					this.data.links.push({source: app.name, target: topic});
			});
			app.topicsMatchingSubscriptions.forEach(topic => {
				allTopics.add(topic);
				this.data.links.push({target: app.name, source: topic});
			});
		});
		allTopics.forEach(topic => {
			this.data.nodes.push({id: topic, group: 2});
		});
  }
  

	attached() {
		this.group = d3.select(this.canvas);
		const width = 1200;
		const height = 800;

    var color = d3.scaleOrdinal(d3.schemeCategory20);
    
		this.simulation = d3.forceSimulation()
			.force("link", d3.forceLink().id(function(d) { return d.id; }))
			.force("charge", d3.forceManyBody().strength(-600))
			.force("center", d3.forceCenter(width / 2, height / 2));

		this.links = this.group.append("g")
			.attr("class", "links")
			.selectAll("line")
			.data(this.data.links)
				.enter()
        .append("line")
        .attr("id", "oldLine")
        .attr("stroke-width", 1);
        
        debugger;

		this.nodes = this.group.append("g")
			.attr("class", "nodes")
			.selectAll("g")
			.data(this.data.nodes)
			.enter().append("g");
			
		this.nodes.append("circle")
				.attr("r", d => d.group === 1 ? 10 : 5)
				.attr("fill", function(d) { return color(d.group); })
				.on("click", d => {
					this.selected = d;
				})
				.call(d3.drag()
						.on("start", this.dragstarted.bind(this))
						.on("drag", this.dragged.bind(this))
						.on("end", this.dragended.bind(this)));

		this.nodes.append("text")
				.text(function(d) {
					return d.id;
				})
				.attr('x', 6)
				.attr('y', 3);

		this.nodes.append("title")
				.text(function(d) { return d.id; });

		this.simulation
				.nodes(this.data.nodes)
				.on("tick", this.ticked.bind(this));

		this.simulation.force("link")
				.links(this.data.links);
	}

	ticked() {
			this.links
				.attr("x1", function(d) { return d.source.x; })
				.attr("y1", function(d) { return d.source.y; })
				.attr("x2", function(d) { return d.target.x; })
				.attr("y2", function(d) { return d.target.y; });

			this.nodes
				.attr("transform", function(d) {
					return "translate(" + d.x + "," + d.y + ")";
				})
	}

	dragstarted(d) {
		if (!d3.event.active) {
			this.simulation.alphaTarget(0.3).restart();
		}
		d.fx = d.x;
		d.fy = d.y;
	}
	
	dragged(d) {
		d.fx = d3.event.x;
		d.fy = d3.event.y;
	}
	
	dragended(d) {
		if (!d3.event.active) this.simulation.alphaTarget(0);
		d.fx = null;
		d.fy = null;
  }
  
  addNewTopic(app, topic) {
    console.log(app, topic);
    const node = this.data.nodes.find(node => node.id === topic);
    this.data.links.push({source: app.id, target: topic});
    const link = this.group
      .select(".links")
      .selectAll("line")
			.data(this.data.links)
				.enter()
        .insert("line")
        .attr("id", "newLine")
        .attr("stroke-width", 1);
        this.simulation
				.nodes(this.data.nodes)
				.on("tick", this.ticked.bind(this));

		this.simulation.force("link")
				.links(this.data.links);
        this.simulation.restart();

  }
}
